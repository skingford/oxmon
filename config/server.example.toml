# oxmon Server Configuration

# gRPC port for receiving metrics from agents
grpc_port = 9090

# HTTP port for REST API
http_port = 8080

# Directory for metric data storage (SQLite partition files)
data_dir = "data"

# How many days to retain metric data
retention_days = 7

# Require agent authentication (default: false)
# When enabled, agents must provide a valid token in the whitelist
# Manage whitelist via: POST/GET/DELETE /v1/agents/whitelist
require_agent_auth = false

# REST API Authentication (JWT)
# All REST API endpoints (except health check and login) require a valid JWT token.
# Obtain a token via: POST /v1/auth/login
[auth]
# JWT signing secret. If not set, a random secret is generated on each startup
# (tokens will be invalidated on restart). Set a fixed value for production.
jwt_secret = "your-secret-key-here"
token_expire_secs = 86400       # Token validity period (default: 24 hours)
default_username = "admin"      # Default admin username (created on first startup)
default_password = "changeme"   # Default admin password (created on first startup)

# Alert Rules
# Supported types: "threshold", "rate_of_change", "trend_prediction", "cert_expiration"

[[alert.rules]]
name = "high-cpu"
type = "threshold"
metric = "cpu.usage"
agent_pattern = "*"
operator = "greater_than"
value = 90.0
duration_secs = 300
severity = "critical"
silence_secs = 600

[[alert.rules]]
name = "memory-spike"
type = "rate_of_change"
metric = "memory.used_percent"
agent_pattern = "*"
rate_threshold = 20.0
window_secs = 300
severity = "warning"
silence_secs = 600

[[alert.rules]]
name = "disk-full-prediction"
type = "trend_prediction"
metric = "disk.used_percent"
agent_pattern = "*"
predict_threshold = 95.0
horizon_secs = 86400
min_data_points = 10
severity = "info"
silence_secs = 3600

# Certificate expiration alert (uses dedicated cert_expiration rule type)
# Triggers warning at 30 days, critical at 7 days before expiry
[[alert.rules]]
name = "cert-expiry"
type = "cert_expiration"
metric = "certificate.days_until_expiry"
agent_pattern = "cert-checker"
severity = "critical"
warning_days = 30
critical_days = 7
silence_secs = 86400

# Certificate invalid
[[alert.rules]]
name = "cert-invalid"
type = "threshold"
metric = "certificate.is_valid"
agent_pattern = "cert-checker"
operator = "less_than"
value = 1.0
duration_secs = 0
severity = "critical"
silence_secs = 3600

# Notification
#
# Channels and silence windows are managed via REST API or the `init-channels` CLI:
#
#   oxmon-server init-channels config/server.toml config/channels.seed.json
#
# See config/channels.seed.example.json for a seed file template.
#
# REST API endpoints:
#   POST   /v1/notifications/channels/config       Create a channel
#   GET    /v1/notifications/channels               List channels (with recipients)
#   PUT    /v1/notifications/channels/config/{id}   Update a channel
#   DELETE /v1/notifications/channels/config/{id}   Delete a channel
#   PUT    /v1/notifications/channels/{id}/recipients   Set recipients
#   POST   /v1/notifications/channels/{id}/test     Send test notification
#   GET    /v1/notifications/silence-windows         List silence windows
#   POST   /v1/notifications/silence-windows         Create silence window
#   DELETE /v1/notifications/silence-windows/{id}    Delete silence window
#
# Built-in channel types: email, webhook, sms, dingtalk, weixin

[notification]
# Aggregation window for batching similar alerts (seconds)
aggregation_window_secs = 60

# Certificate Check Configuration
# Server periodically checks TLS certificates for monitored domains.
# Domains are managed via REST API: POST/GET/PUT/DELETE /v1/certs/domains

[cert_check]
enabled = true
default_interval_secs = 86400   # Default check interval (24 hours)
tick_secs = 60                  # Scheduler tick interval
connect_timeout_secs = 10       # TLS connection timeout per domain
max_concurrent = 10              # Max concurrent TLS connections
