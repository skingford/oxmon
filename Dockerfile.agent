FROM --platform=$BUILDPLATFORM rust:1.84 AS builder
ARG TARGETARCH

WORKDIR /app
COPY . .

# Map docker platform arch to Rust target triple
RUN case "$TARGETARCH" in \
      amd64) TARGET="x86_64-unknown-linux-gnu" ;; \
      arm64) TARGET="aarch64-unknown-linux-gnu" ;; \
      *)     echo "Unsupported arch: $TARGETARCH" && exit 1 ;; \
    esac && \
    rustup target add "$TARGET" && \
    cargo build --release --target "$TARGET" --bin oxmon-agent && \
    cp "target/$TARGET/release/oxmon-agent" /app/oxmon-agent

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/oxmon-agent /usr/local/bin/
COPY config/agent.example.toml /etc/oxmon/agent.toml
ENTRYPOINT ["oxmon-agent", "/etc/oxmon/agent.toml"]
